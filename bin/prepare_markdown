#!/bin/bash
awk 'BEGIN {
    in_code = 0;
	ref_idx = 1;
}
substr($1, 1, 3) == "```" {
    in_code = (in_code + 1) % 2;
}
substr($1, 1, 1) != "#" || in_code != 0{
	print $0
}
substr($1, 1, 1) == "#" && in_code == 0{
	match($0, "[^# ]", match_ret);
    curr_level = length($1);
	print "<h" curr_level " id=\"ref-" (ref_idx ++) "\">" substr($0, match_ret[0, "start"]) "</h" curr_level ">";
}
' "$1" > "$2"
